{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Chat{% endblock %}

{% block content %}
<div class="container" style="max-width: 100%; padding: 15px 0 70px 0;">
    <div style="padding: 0 15px;">
        <!-- Back Button -->
        <a href="{{ url_for('home') }}" style="display: inline-block; margin-bottom: 15px; color: var(--primary-color); text-decoration: none;">
            <i class="fas fa-arrow-left"></i> Zurück zur Übersicht
        </a>

        <!-- Chat Container -->
        <div class="card" style="border-radius: 10px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h2 style="margin: 0; color: var(--primary-color);">Chat</h2>
            </div>
            
            <!-- Messages Container -->
            <div id="messages" style="height: 60vh; overflow-y: auto; padding: 15px; background: #f9f9f9;">
                <!-- Messages will be loaded here via JavaScript -->
                <div style="text-align: center; padding: 20px; color: #888;">
                    <i class="fas fa-comment-dots" style="font-size: 2em; opacity: 0.5; margin-bottom: 10px; display: block;"></i>
                    <p>Lade Nachrichten...</p>
                </div>
            </div>
            
            <!-- Message Input -->
            <div style="padding: 15px; background: white; border-top: 1px solid #eee;">
                <form id="message-form" style="display: flex; gap: 10px;">
                    <input type="text" id="message-input" 
                           style="flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; outline: none;"
                           placeholder="Schreibe eine Nachricht..." autocomplete="off">
                    <button type="submit" class="btn btn-primary" style="border-radius: 20px; padding: 0 20px;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
{% include 'campaign_bottom_nav.html' %}

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    /* Chat message styling */
    .message {
        display: flex;
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
        flex-shrink: 0;
    }
    
    .message-avatar-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .message-avatar-icon i {
        font-size: 1.5em;
        color: #666;
    }
    
    .message-content {
        max-width: 80%;
    }
    
    .message-header {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
    }
    
    .message-sender {
        font-weight: bold;
        margin-right: 8px;
    }
    
    .message-time {
        font-size: 0.8em;
        color: #888;
    }
    
    .message-text {
        background: white;
        padding: 10px 15px;
        border-radius: 15px;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Message alignment */
    .message.self {
        flex-direction: row-reverse;
    }
    
    .message.self .message-avatar {
        margin-right: 0;
        margin-left: 10px;
    }
    
    .message.self .message-content {
        text-align: right;
    }
    
    .message.self .message-text {
        background: var(--primary-color);
        color: white;
    }
    
    .message.self .message-time {
        text-align: right;
    }
    
    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Scrollbar styling */
    #messages::-webkit-scrollbar {
        width: 6px;
    }
    
    #messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #messages::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }
    
    #messages::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        // Load messages
        function loadMessages() {
            fetch(`/campaign/{{ campaign.id }}/chat/messages`)
                .then(response => response.json())
                .then(messages => {
                    // Clear the container
                    messagesContainer.innerHTML = '';
                    
                    // Add messages in chronological order (oldest first)
                    messages.forEach(message => {
                        addMessageToChat(message, false);
                    });
                    
                    // Scroll to bottom to show newest messages
                    scrollToBottom();
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Fehler beim Laden der Nachrichten</div>';
                });
        }
        
        // Add a message to the chat
        function addMessageToChat(message, isNew = true) {
            const isSelf = message.is_dm || (message.sender_name !== 'DM' && '{{ current_user.id }}' === '{{ campaign.dm_id }}');
            const messageTime = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSelf ? 'self' : ''}`;
            
            // Check if character_image is a Font Awesome class or an image URL
            const isFontAwesome = message.character_image && 
                                (message.character_image.startsWith('fas fa-') || 
                                 message.character_image.startsWith('far fa-') || 
                                 message.character_image.startsWith('fab fa-'));
            
            const avatarHTML = isFontAwesome 
                ? `<div class="message-avatar-icon"><i class="${message.character_image}"></i></div>`
                : `<img src="${message.character_image}" alt="${message.sender_name}" class="message-avatar">`;
            
            messageElement.innerHTML = `
                ${avatarHTML}
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${message.character_name || message.sender_name}</span>
                        <span class="message-time">${messageTime}</span>
                    </div>
                    <div class="message-text">${message.content}</div>
                </div>
            `;
            
            if (isNew) {
                messagesContainer.appendChild(messageElement);
                scrollToBottom();
            } else {
                messagesContainer.appendChild(messageElement);
            }
        }
        
        // Send a new message
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const content = messageInput.value.trim();
            
            if (content) {
                // Show sending state
                const submitButton = messageForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                console.log('Preparing to send message:', content);
                
                const formData = new FormData();
                formData.append('content', content);
                
                fetch(`/campaign/{{ campaign.id }}/chat/send`, {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    console.log('Response status:', response.status);
                    const responseText = await response.text();
                    console.log('Response text:', responseText);
                    
                    try {
                        // Try to parse as JSON
                        const data = JSON.parse(responseText);
                        if (!response.ok) {
                            throw new Error(data.error || 'Server error');
                        }
                        return data;
                    } catch (e) {
                        // If not JSON, it's probably an HTML error page
                        console.error('Failed to parse response as JSON:', e);
                        throw new Error(`Server returned status ${response.status}. The server might be experiencing issues.`);
                    }
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        messageInput.value = '';
                        // The message will be added via the real-time update
                    } else {
                        throw new Error(data.error || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    alert('Fehler beim Senden der Nachricht: ' + (error.message || 'Unbekannter Fehler'));
                })
                .finally(() => {
                    // Reset button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                });
            }
        });
        
        // Auto-scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Load messages initially
        loadMessages();
        
        // Check for new messages periodically (every 5 seconds)
        setInterval(loadMessages, 5000);
        
        // Focus the input field when the page loads
        messageInput.focus();
    });
</script>
{% endblock %}
